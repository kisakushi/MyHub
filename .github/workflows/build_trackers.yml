name: Build Tracker MRS Rule

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download and Clean XIU2 Trackers
        run: |
          # 1. 下载原始数据 (使用 cf 加速源)
          curl -sSL "https://cf.trackerslist.com/all.txt" -o raw_trackers.txt

          # 2. 数据清洗
          # 逻辑：去除空行 -> 去除协议/端口/路径 -> 去重
          # ⚠️ 关键修改：直接使用完整域名，不做危险的根域名提取
          cat raw_trackers.txt | grep -v "^$" | \
          sed -E 's#^[a-zA-Z0-9]+://##; s#:[0-9]+.*$##; s#/.*$##' | \
          sort | uniq > cleaned_domains.txt

          # 3. 生成 Mihomo YAML
          echo "payload:" > tracker_source.yaml
          awk '{print "  - DOMAIN-SUFFIX," $1}' cleaned_domains.txt >> tracker_source.yaml

          echo "=== Generated YAML Content (Top 10) ==="
          head -n 10 tracker_source.yaml

      - name: Setup Mihomo and Compile
        run: |
          # 使用较新的 v1.19.16 内核
          wget https://github.com/MetaCubeX/mihomo/releases/download/v1.19.16/mihomo-linux-amd64-v1.19.16.gz
          gunzip mihomo-linux-amd64-v1.19.16.gz
          mv mihomo-linux-amd64-v1.19.16 mihomo
          chmod +x mihomo

          ./mihomo convert-ruleset domain yaml tracker_source.yaml trackers.mrs

      - name: Commit and Push
        run: |
          # 1. 清理垃圾文件 (只保留生成的 rules 和 git 目录)
          # 这一步很重要，防止把 mihomo 这种大文件传到仓库里
          rm -f raw_trackers.txt cleaned_domains.txt optimized_domains.txt tracker_source.yaml mihomo

          # 2. 配置 Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 3. 强制生成一个日志文件 (为了触发更新)
          # 写入当前时间到 log 文件，这样 Git 就会认为有“新变化”
          echo "Last check: $(date)" > update_log.txt

          # 4. 提交
          git add trackers.mrs update_log.txt
          git commit -m "Auto-update trackers.mrs" || exit 0
          git push
